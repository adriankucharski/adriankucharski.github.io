<!DOCTYPE html>

<head>
</head>

<body>
    <h2>Laboratorium 6</h2>
    <h3 id="game_status">GO!</h3>
    <canvas id="canvas_element" width="800px" height="600px" style="border: 1px solid;"></canvas>
    <script>
        const rotateCanvas = (degree, canvas) => {
            const radians = degree * Math.PI / 180;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(radians);
            ctx.translate(-canvas.width / 2, -canvas.height / 2);
        }
        const getRandomInt = (min, max) => {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        class Car {
            constructor(x, canvas, minX, maxX, width = 80, height = 145) {
                this.ctx = canvas.getContext('2d');
                this.x = x;
                this.y = canvas.height - height;

                this.width = width;
                this.height = height;
                this.wheelWidth = 20;
                this.wheelHeight = 40;

                this.minX = minX;
                this.maxX = maxX;

                this.minY = 0;
                this.maxY = canvas.height - height;

                this.carColor = '#aa2266';
            }

            draw() {
                this.ctx.fillStyle = this.carColor;
                this.ctx.fillRect(this.x, this.y, this.width, this.height);

                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(this.x - this.wheelWidth, this.y, this.wheelWidth, this.wheelHeight);
                this.ctx.fillRect(this.x + this.width, this.y, this.wheelWidth, this.wheelHeight);
                this.ctx.fillRect(this.x - this.wheelWidth, this.y + this.height - this.wheelHeight, this.wheelWidth, this.wheelHeight);
                this.ctx.fillRect(this.x + this.width, this.y + this.height - this.wheelHeight, this.wheelWidth, this.wheelHeight);
            }

            move(x, y) {
                let newX = this.x + x;
                let newY = this.y + y;
                if (newX > (this.minX + this.wheelWidth / 2) && newX < (this.maxX - this.wheelWidth / 2 - this.width))
                    this.x = newX;
                if (newY >= this.minY && newY <= this.maxY)
                    this.y = newY;
            }

            detectCollision(rx, ry, rw, rh) {
                const x = this.x - this.wheelWidth;
                const w = this.width + 2 * this.wheelWidth;
                const isDetected = (x < rx + rw &&
                    x + w > rx &&
                    this.y < ry + rh &&
                    this.height + this.y > ry);
                this.carColor = isDetected ? '#aa2266' : '#002211';
                return isDetected;
            }

            position() {
                return [this.x, this.y, this.width, this.height];
            }
        }

        class Rectangle {
            constructor(x, canvas, y = 0, width = 20, height = 20, speed = 15, color = '#e9ed5f') {
                this.color = color;
                this.y = y;
                this.x = x;
                this.speed = speed;
                this.canvas = canvas;
                this.width = width;
                this.height = height;
                this.ctx = canvas.getContext('2d');
            }
            move(y = this.speed) {
                this.y += y;
            }
            draw() {
                this.ctx.fillStyle = this.color;
                this.ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            isVisible() {
                return this.canvas.height > this.y || this.y < 0;
            }
            position() {
                return [this.x, this.y, this.width, this.height];
            }
            detectCollision(rx, ry, rw, rh) {
                const x = this.x;
                const w = this.width;
                const isDetected = (x < rx + rw &&
                    x + w > rx &&
                    this.y < ry + rh &&
                    this.height + this.y > ry);
                return isDetected;
            }
        }

        class Game {
            constructor() {
                this.canvas = document.querySelector('#canvas_element');
                this.ctx = this.canvas.getContext('2d');

                this.midLineWidth = 30;
                this.midLineHeight = 50;
                this.midLineY = [0, 100, 200, 300, 400, 500, 600];

                this.borderLineWidth = 60;
                this.borderLineWHeight = 100;
                this.borderLineY = [-100, 0, 100, 200, 300, 400, 500, 600];

                this.lineStep = 5;

                this.obstackleY = undefined;
                this.obstackleX = undefined;
                this.obstackleWidth = 150;
                this.obstackleHeight = 140;
                this.obstackleStepY = 6;
                this.obstackleStepX = -4.5;

                this.bonuses = [];
                this.bullets = [];
            }

            drawMidLines() {
                this.ctx.fillStyle = '#fff';
                for (let i = 0; i < this.midLineY.length; ++i)
                    this.ctx.fillRect((this.canvas.width - this.midLineWidth) / 2, this.midLineY[i], this.midLineWidth, this.midLineHeight);

                this.midLineY = this.midLineY.map(x => {
                    let newX = x + this.lineStep;
                    return newX > (this.canvas.height + this.midLineHeight) ? -this.midLineHeight + this.lineStep : newX;
                });
            }

            drawBroder() {
                for (let i = 0; i < this.borderLineY.length; ++i) {
                    this.ctx.fillStyle = i % 2 ? '#fff' : '#f00';
                    this.ctx.fillRect(0, this.borderLineY[i], this.borderLineWidth, this.borderLineWHeight);
                    this.ctx.fillRect(this.canvas.width - this.borderLineWidth, this.borderLineY[i], this.borderLineWidth, this.borderLineWHeight);
                }

                this.borderLineY = this.borderLineY.map(x => {
                    let newX = x + this.lineStep;
                    return newX > (this.canvas.height + this.borderLineWHeight) ? -this.borderLineWHeight + this.lineStep : newX;
                });
            }

            drawObstackle() {
                if (this.obstackleX === undefined) {
                    this.obstackleX = getRandomInt(this.borderLineWidth, this.canvas.width - this.obstackleWidth - this.borderLineWidth);
                    this.obstackleY = -this.obstackleHeight;
                }

                this.ctx.fillStyle = '#4455cc';
                this.ctx.fillRect(this.obstackleX, this.obstackleY, this.obstackleWidth, this.obstackleHeight);


                this.obstackleY += this.obstackleStepY;
                this.obstackleX += this.obstackleStepX;

                if (this.obstackleX > this.canvas.width - this.borderLineWidth - this.obstackleWidth) {
                    this.obstackleX = this.canvas.width - this.borderLineWidth - this.obstackleWidth;
                    this.obstackleStepX = -this.obstackleStepX;
                }
                if (this.obstackleX < this.borderLineWidth) {
                    this.obstackleX = this.borderLineWidth;
                    this.obstackleStepX = -this.obstackleStepX;
                }
                if (this.obstackleY > this.canvas.height)
                    this.obstackleX = undefined;
            }

            drawBoard() {
                this.ctx.fillStyle = '#aaa';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            drawBonuses() {
                for (let i = this.bonuses.length - 1; i >= 0; --i) {
                    const bonus = this.bonuses[i];
                    bonus.draw();
                    bonus.move();
                    !bonus.isVisible() && this.bonuses.splice(i, 1);
                }
            }
            drawBullets() {
                for (let i = this.bullets.length - 1; i >= 0; --i) {
                    const bullet = this.bullets[i];
                    bullet.draw();
                    bullet.move();
                    const isDetected = bullet.detectCollision(this.obstackleX, this.obstackleY, this.obstackleWidth, this.obstackleHeight);
                    if (!bullet.isVisible() || isDetected)
                        this.bullets.splice(i, 1);

                    if (isDetected) {
                        this.obstackleX = getRandomInt(this.borderLineWidth, this.canvas.width - this.obstackleWidth - this.borderLineWidth);
                        this.obstackleY = -this.obstackleHeight;
                    }
                }
            }
            drawText(text, x = 10, y = 50) {
                this.ctx.fillStyle = "black";
                this.ctx.font = "30px Arial";
                this.ctx.fillText(text, x, y);
            }
            clearContext() {
                this.ctx.save();
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
                this.ctx.restore();
            }
            rotateCanvas(degree) {
                const radians = degree * Math.PI / 180;
                this.ctx.translate(this.canvas.width / 2, this.canvas.height / 2);
                this.ctx.rotate(radians);
                this.ctx.translate(-this.canvas.width / 2, -this.canvas.height / 2);
            }

            start() {
                const car = new Car(200, this.canvas, this.borderLineWidth, this.canvas.width - this.borderLineWidth);
                let MOVE_X = 0;
                let MOVE_Y = 0;
                let SHOOT = false;
                let RELOAD_TIME = 500;
                let CAN_SHOOT = true;
                let POINTS = 0;
                let SPEED = 5;


                window.addEventListener('keydown', (e) => {
                    if (e.keyCode === 37) MOVE_X = -10;
                    if (e.keyCode === 38) MOVE_Y = -10;
                    if (e.keyCode === 39) MOVE_X = +10;
                    if (e.keyCode === 40) MOVE_Y = +10;
                    if (e.keyCode === 32) SHOOT = true;
                    if (e.keyCode === 65) SPEED += (SPEED < 10) ? 1 : 0;
                    if (e.keyCode === 90) SPEED -= (SPEED > 1) ? 1 : 0;
                })
                window.addEventListener('keyup', (e) => {
                    if (e.keyCode === 37 && MOVE_X === -10) MOVE_X = 0;
                    if (e.keyCode === 38 && MOVE_Y === -10) MOVE_Y = 0;
                    if (e.keyCode === 39 && MOVE_X === +10) MOVE_X = 0;
                    if (e.keyCode === 40 && MOVE_Y === +10) MOVE_Y = 0;
                    if (e.keyCode === 32) SHOOT = false;
                });


                let ROTATE = 0;
                let ROTATE_DIR = 1;
                const ROTATE_ANGLE = 2;
                const rotateInterval = setInterval(() => {
                    if (ROTATE_DIR === 1 && ROTATE <= 30) {
                        if (ROTATE > 15)
                            this.rotateCanvas(ROTATE_ANGLE);
                        if (ROTATE === 30)
                            ROTATE_DIR = -1;
                        else
                            ROTATE += ROTATE_DIR;
                    }
                    if (ROTATE >= -15) {
                        if (ROTATE < 0 && ROTATE_DIR === -1 || ROTATE < 0 && ROTATE_DIR === 1)
                            this.rotateCanvas(ROTATE_ANGLE * ROTATE_DIR);
                    }
                    if (ROTATE_DIR === -1 && ROTATE >= -45) {
                        if (ROTATE < -30)
                            this.rotateCanvas(-ROTATE_ANGLE);

                        if (ROTATE === -45)
                            ROTATE_DIR = 1;
                        else
                            ROTATE += ROTATE_DIR;
                    }
                }, 100);


                const bonusInterval = setInterval(() => {
                    const [w, h] = [20, 20];
                    const posx = getRandomInt(this.borderLineWidth + w, this.canvas.width - this.borderLineWidth - w);
                    const bonus = new Rectangle(posx, this.canvas, 0, w, h)
                    this.bonuses.push(bonus);
                }, 500);

                const intrval = setInterval(() => {
                    car.move(MOVE_X * (SPEED / 10), MOVE_Y * (SPEED / 10));
                    if (CAN_SHOOT && SHOOT) {
                        CAN_SHOOT = false;
                        const [x, y, w, _] = car.position();
                        this.bullets.push(new Rectangle(x, this.canvas, y, 15, 15, -20, '#322d31'));
                        // this.bullets.push(new Rectangle(x + w / 2, this.canvas, y, 15, 15, -20, '#322d31'));
                        const canShootInterval = setTimeout(() => CAN_SHOOT = true, RELOAD_TIME)
                    }
                    const isDetected = car.detectCollision(this.obstackleX, this.obstackleY, this.obstackleWidth, this.obstackleHeight);
                    for (let i = this.bonuses.length - 1; i >= 0; --i) {
                        const bonus = this.bonuses[i];
                        const [rx, ry, rw, rh] = bonus.position();
                        if (car.detectCollision(rx, ry, rw, rh)) {
                            ++POINTS;
                            RELOAD_TIME > 200 && --RELOAD_TIME;
                            this.bonuses.splice(i, 1);
                        }
                    }

                    this.clearContext();
                    this.drawBoard();
                    this.drawBroder();
                    this.drawMidLines();
                    this.drawBonuses();
                    this.drawObstackle();
                    this.drawBullets();
                    this.drawText(`Points: ${POINTS}`);
                    this.drawText(`Reload time (ms): ${RELOAD_TIME}`, 10, 75);
                    this.drawText(`Speed: ${SPEED}`, 10, 100);
                    car.draw();

                    if (isDetected) {
                        clearInterval(intrval);
                        clearInterval(bonusInterval);
                        clearInterval(rotateInterval);
                        document.querySelector("#game_status").innerText = 'Game over!';
                    }
                }, 10);
            }
        }

        (function () {
            const game = new Game();
            game.start();
        })();
    </script>
</body>

</html>