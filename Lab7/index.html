<!DOCTYPE html>

<head>
</head>

<body>
    <h2>Laboratorium 7</h2>
    <h3 id="game_status">GO!</h3>
    <canvas id="canvas_element" width="800px" height="600px" style="border: 1px solid;"></canvas>
    <script>
        let keys = {};
        let lastkey = false;
        document.addEventListener('keydown', function (evt) {
            keys[evt.keyCode] = true;
        });
        document.addEventListener('keyup', function (evt) {
            keys[evt.keyCode] = false;
        });



        const canvas = document.getElementById('canvas_element');
        const ctx = canvas.getContext('2d');

        let jump = false;
        let floorY = canvas.height - 50 - 55;


        const getRandomInt = (min, max) => {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        class Car {
            constructor(x, y, width = 100, height = 40, wheelR = 15) {
                this.x = x;
                this.y = y;

                this.width = width;
                this.height = height;
                this.wheelR = wheelR;

                this.carColor = '#aa2266';
                this.wheelsColor = '#000'

                this.gravity = -1.5;
                this.gravitySpeed = 0;
                this.goDown = false;
            }

            draw() {
                ctx.fillStyle = this.carColor;
                ctx.fillRect(this.x, this.y, this.width, this.height);

                ctx.fillStyle = '#4444ff';
                ctx.fillRect(this.x + 80, this.y, this.width - 80, this.height - 20);

                ctx.beginPath();
                ctx.arc(this.x + this.wheelR, this.y + this.height, this.wheelR, 0, 2 * Math.PI);
                ctx.arc(this.x + this.width - this.wheelR, this.y + this.height, this.wheelR, 0, 2 * Math.PI);
                ctx.fillStyle = this.wheelsColor;
                ctx.fill();
            }

            jump() {
                if (jump) {
                    this.gravitySpeed += this.gravity;
                    this.y += this.gravitySpeed;
                    if (this.gravitySpeed < this.gravity * 15) {
                        jump = false;
                    }
                } else {
                    if (this.y >= floorY) {
                        this.y = floorY;
                        this.gravitySpeed = 0;
                        lastkey = false;
                    }
                    else {
                        this.gravitySpeed += Math.abs(this.gravity) + 0.5;
                        this.y += this.gravitySpeed;
                    }
                }
            }

            position() {
                return [this.x, this.y, this.width, this.height];
            }
        }

        class Rectangle {
            constructor(x, y, width = 40, height = 80, speed = 15, color = '#aaaaa') {
                this.color = color;
                this.y = y;
                this.x = x;
                this.speed = speed;
                this.width = width;
                this.height = height;
            }
            move(s = this.speed) {
                this.x -= s;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            isInvisible() {
                return !(canvas.width > this.x && this.x > 0);
            }
            position() {
                return [this.x, this.y, this.width, this.height];
            }
            detectCollision(rx, ry, rw, rh) {
                const x = this.x;
                const w = this.width;
                const isDetected = (x < rx + rw &&
                    x + w > rx &&
                    this.y < ry + rh &&
                    this.height + this.y > ry);
                return isDetected;
            }
        }

        class Game {
            constructor() {
                this.borderLineWidth = 115;
                this.borderLineWHeight = 50;

                this.borderLineX = Array.from(Array(8).keys()).map(x => x * this.borderLineWidth);
                this.lineStep = 5;


            }


            drawBroder() {
                for (let i = 0; i < this.borderLineX.length; ++i) {
                    ctx.fillStyle = i % 2 ? '#fff' : '#f00';
                    ctx.fillRect(this.borderLineX[i], canvas.height - this.borderLineWHeight, this.borderLineWidth, this.borderLineWHeight);
                }
                this.borderLineX = this.borderLineX.map(x => {
                    let newX = x - this.lineStep;
                    return newX > -this.borderLineWidth ? newX : canvas.width;
                });
            }


            drawBoard() {
                ctx.fillStyle = '#aaa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            drawText(text, x = 10, y = 50) {
                ctx.fillStyle = "black";
                ctx.font = "30px Arial";
                ctx.fillText(text, x, y);
            }
            clearContext() {
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.restore();
            }
            start() {

                const minYobstackle = canvas.height - this.borderLineWHeight - 80;
                const maxYobstackle = minYobstackle - 80;
                console.log(maxYobstackle, minYobstackle);
                const car = new Car(150, canvas.height - this.borderLineWHeight - 55);
                const obstackle = new Rectangle(canvas.width, getRandomInt(maxYobstackle, minYobstackle));
                const intrval = setInterval(() => {
                    if (keys[32]) {
                        if (!lastkey) jump = true;
                        lastkey = true;
                    }


                    this.clearContext();
                    this.drawBoard();

                    this.drawBroder();
                    obstackle.draw();
                    car.draw();
                    car.jump();

                    const [x, y, w, h] = car.position();
                    if (obstackle.detectCollision(x, y, w, h)) {
                        clearInterval(intrval);
                        document.getElementById('game_status').innerText = 'Game over!'
                    }

                    obstackle.move(10);
                    if (obstackle.isInvisible()) {
                        obstackle.x = canvas.width;
                        obstackle.y = getRandomInt(maxYobstackle, minYobstackle);
                    }
                }, 15);
            }
        }

        (function () {
            const game = new Game();
            game.start();
        })();
    </script>
</body>

</html>